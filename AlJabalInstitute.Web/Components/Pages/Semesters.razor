@page "/Semesters"
@layout MainLayout
@rendermode InteractiveServer

@inject AlJabalInstitute.Web.Services.DataServices DataServices
@inject NavigationManager Nav

<div class="semesters-page">

    <!-- Header -->
    <div class="page-header">
        <h2>السيمسترات</h2>
        <button class="add-btn" @onclick="OpenAddDialog">
            <i class="fas fa-plus-circle ml-2"></i>
            إضافة سمستر جديد
        </button>
    </div>

    <!-- Cards -->
    <div class="cards-container">
        @if (SemesterList.Count == 0)
        {
            <p>
                <i class="fas fa-calendar-times ml-2"></i>
                لا توجد سيمسترات بعد
            </p>
        }
        else
        {
            @foreach (var s in SemesterList)
            {
                <div class="semester-card">

                    <!-- Header -->
                    <div class="card-header">
                        <span class="semester-name">
                            <i class="fas fa-graduation-cap ml-2"></i>
                            @s.SemesterName
                        </span>

                        <span class="status-badge @(s.IsFinished ? "inactive" : "active")">
                            @(s.IsFinished ? "غير نشط" : "نشط")
                        </span>
                    </div>

                    <!-- Body -->
                    <div class="card-body">
                        <div class="date">
                            📅 @s.StartDate.ToString("yyyy/MM/dd")
                            →
                            @(s.EndDate.HasValue
                                                ? s.EndDate.Value.ToString("yyyy/MM/dd")
                                                : "—")
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card-actions">
                        <button class="delete-btn"
                                @onclick="() => OpenDeleteDialog(s)">
                            <i class="fas fa-trash ml-2"></i>
                            حذف
                        </button>

                        <button class="toggle-btn"
                                @onclick="() => ToggleStatus(s)">
                            <i class="fas fa-toggle-on ml-2"></i>
                            @(s.IsFinished ? "تفعيل" : "إنهاء")
                        </button>

                        <button class="edit-btn"
                                @onclick="() => OpenEditDialog(s)">
                            <i class="fas fa-edit ml-2"></i>
                            تعديل
                        </button>
                    </div>

                    <!-- Details -->
                    <button class="details-link"
                            @onclick="() => GoToDetails(s.Id)">
                        <i class="fas fa-eye ml-2"></i>
                        عرض تفاصيل السمستر والمواد
                    </button>

                </div>
            }
        }
    </div>

</div>

<!-- ================= ADD / EDIT DIALOG ================= -->
@if (ShowFormDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box dialog-accent">

            <h3>
                <i class="fas fa-ml-2"></i>
                @DialogTitle
            </h3>

            <input class="rtl-input"
                   placeholder="اسم السمستر"
                   @bind="FormName" />

            <input type="date"
                   class="rtl-input"
                   @bind="FormStart" />

            <input type="date"
                   class="rtl-input"
                   @bind="FormEnd" />

            @if (!string.IsNullOrEmpty(FormError))
            {
                <div class="error-text">
                    <i class="fas fa-exclamation-circle ml-2"></i>
                    @FormError
                </div>
            }

            <button class="dialog-action" @onclick="SaveSemester">
                <i class="fas fa-save ml-2"></i>
                حفظ
            </button>

            <button class="dialog-close" @onclick="CloseFormDialog">
                <i class="fas fa-times ml-2"></i>
                إلغاء
            </button>

        </div>
    </div>
}

<!-- ================= DELETE DIALOG ================= -->
@if (ShowDeleteDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box dialog-danger">

            <h3>
                <i class="fas fa-exclamation-triangle ml-2"></i>
                تأكيد الحذف
            </h3>

            <p>
                هل أنت متأكد من حذف سمستر
                <strong>@SelectedSemester?.SemesterName</strong>؟
            </p>

            <button class="dialog-action danger" @onclick="ConfirmDelete">
                <i class="fas fa-trash ml-2"></i>
                نعم، احذف
            </button>

            <button class="dialog-close" @onclick="CloseDeleteDialog">
                <i class="fas fa-times ml-2"></i>
                إلغاء
            </button>

        </div>
    </div>
}

@code {

    // ===================== DATA =====================
    List<AlJabalInstitute.Web.Models.Semesters> SemesterList = new();
    AlJabalInstitute.Web.Models.Semesters? SelectedSemester;

    // ===================== DIALOG STATE =====================
    bool ShowFormDialog = false;
    bool ShowDeleteDialog = false;

    string DialogTitle = "";
    string FormName = "";
    DateTime FormStart = DateTime.Today;
    DateTime FormEnd = DateTime.Today.AddMonths(3);
    string FormError = "";

    protected override async Task OnInitializedAsync()
    {
        if (!DataServices.IsLoggedIn)
        {
            Nav.NavigateTo("/login");
            return;
        }

        SemesterList = await DataServices.GetSemestersAsync();
    }

    // ===================== NAVIGATION =====================
    void GoToDetails(Guid semesterId)
    {
        Nav.NavigateTo($"/SemesterSubjects/{semesterId}");
    }

    // ===================== ADD / EDIT =====================
    void OpenAddDialog()
    {
        DialogTitle = "إضافة سمستر";
        SelectedSemester = null;
        FormName = "";
        FormStart = DateTime.Today;
        FormEnd = DateTime.Today.AddMonths(3);
        FormError = "";
        ShowFormDialog = true;
    }

    void OpenEditDialog(AlJabalInstitute.Web.Models.Semesters s)
    {
        DialogTitle = "تعديل سمستر";
        SelectedSemester = s;
        FormName = s.SemesterName;
        FormStart = s.StartDate;
        FormEnd = s.EndDate ?? DateTime.Today.AddMonths(3);
        FormError = "";
        ShowFormDialog = true;
    }

    void CloseFormDialog()
    {
        ShowFormDialog = false;
    }

    async Task SaveSemester()
    {
        FormError = "";

        if (string.IsNullOrWhiteSpace(FormName))
        {
            FormError = "اسم السمستر مطلوب";
            return;
        }

        if (FormEnd <= FormStart)
        {
            FormError = "تاريخ النهاية يجب أن يكون بعد البداية";
            return;
        }

        if (SelectedSemester == null)
        {
            await DataServices.AddSemesterAsync(new AlJabalInstitute.Web.Models.Semesters
            {
                SemesterName = FormName,
                StartDate = FormStart,
                EndDate = FormEnd,
                IsFinished = false,
                TeacherId = DataServices.CurrentTeacher!.Id
            });
        }
        else
        {
            SelectedSemester.SemesterName = FormName;
            SelectedSemester.StartDate = FormStart;
            SelectedSemester.EndDate = FormEnd;

            await DataServices.UpdateSemesterAsync(SelectedSemester);
        }

        SemesterList = await DataServices.GetSemestersAsync();
        ShowFormDialog = false;
    }

    // ===================== STATUS =====================
    async Task ToggleStatus(AlJabalInstitute.Web.Models.Semesters s)
    {
        s.IsFinished = !s.IsFinished;
        await DataServices.UpdateSemesterAsync(s);
        SemesterList = await DataServices.GetSemestersAsync();
    }

    // ===================== DELETE =====================
    void OpenDeleteDialog(AlJabalInstitute.Web.Models.Semesters s)
    {
        SelectedSemester = s;
        ShowDeleteDialog = true;
    }

    void CloseDeleteDialog()
    {
        ShowDeleteDialog = false;
    }

    async Task ConfirmDelete()
    {
        if (SelectedSemester != null)
        {
            await DataServices.DeleteSemesterAsync(SelectedSemester.Id);
            SemesterList = await DataServices.GetSemestersAsync();
        }

        ShowDeleteDialog = false;
    }
}
