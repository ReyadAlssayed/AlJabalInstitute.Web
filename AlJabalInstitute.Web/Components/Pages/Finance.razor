@page "/Student/Finance/{StudentSemesterId:guid}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using AlJabalInstitute.Web.Services
@using AlJabalInstitute.Web.Models
@attribute [Authorize]

@inject AuthenticationStateProvider AuthProvider
@inject StudentAuthService StudentSvc
@inject NavigationManager Nav
@inject ToastService ToastSvc

<div class="student-finance">

    <div class="fin-header">

        <div class="fin-header-top">
            <div class="fin-kicker">صفحة المالية</div>

            <h2 class="fin-title">
                <span class="fin-sem">@((Header?.SemesterName ?? "السمستر"))</span>
            </h2>

            <div class="student-name">@StudentName</div>
        </div>


        <div class="fin-header-bottom">
            <button type="button" class="back-btn" @onclick="GoBack">
                <span class="icon">←</span>
                رجوع
            </button>
        </div>

    </div>

    @if (!IsReady)
    {
        <div class="loading">جاري تحميل البيانات...</div>
    }
    else if (Header == null)
    {
        <div class="empty">لا توجد بيانات مالية لهذا السمستر.</div>
    }
    else
    {
        var isExempt = Header.IsFinanciallyExempt ?? false;
        var remaining = Header.RemainingAmount ?? 0m;

        <div class="fin-cards">

            <!-- SUMMARY -->
            <div class="fin-card">
                <div class="card-title">ملخص السمستر</div>

                <div class="fin-row">
                    <span class="lbl">سعر السمستر</span>
                    <span class="val">@Money(Header.SemesterPrice)</span>
                </div>

                <div class="fin-row">
                    <span class="lbl">الخصم</span>
                    <span class="val">@Money(Header.DiscountAmount)</span>
                </div>

                <div class="fin-row">
                    <span class="lbl">المدفوع</span>
                    <span class="val">@Money(Header.PaidAmount)</span>
                </div>

                <div class="fin-row">
                    <span class="lbl">المتبقي</span>
                    <span class="val @(isExempt || remaining <= 0 ? "ok" : "warn")">
                        @(isExempt ? "معفي" : Money(remaining))
                    </span>
                </div>

                <div class="fin-row">
                    <span class="lbl">الحالة</span>

                    @if (isExempt)
                    {
                        <span class="pill info">معفي</span>
                    }
                    else if (remaining <= 0)
                    {
                        <span class="pill ok">خالص</span>
                    }
                    else
                    {
                        <span class="pill warn">غير خالص</span>
                    }
                </div>
            </div>

            <!-- PAYMENTS -->
            <div class="fin-card">
                <div class="card-title">الدفعات</div>

                @if (!Payments.Any())
                {
                    <div class="empty small">لا توجد دفعات.</div>
                }
                else
                {
                    <div class="payments-list">
                        @foreach (var p in Payments)
                        {
                            
                            var dt = (p.PaidAt ?? p.CreatedAt).ToLocalTime();
                            var ampm = dt.Hour < 12 ? "صباحًا" : "مساءً";
                            var timeTxt = dt.ToString("hh:mm") + " " + ampm;
                            var dateTxt = dt.ToString("yyyy-MM-dd");

                            <div class="pay-item">
                                <div class="pay-box pay-amt">
                                    <div class="pay-label">القيمة</div>
                                    <div class="pay-value">@Money(p.Amount)</div>
                                </div>

                                <div class="pay-box pay-meta">
                                    <div class="pay-line">
                                        <span class="pay-label">نوع الدفع</span>
                                        <span class="pay-text">@p.PaymentMethod</span>
                                    </div>

                                  

                                    @if (!string.IsNullOrWhiteSpace(p.ReceiverName))
                                    {
                                        <div class="pay-line">
                                            <span class="pay-label">استلمها</span>
                                            <span class="pay-text">@p.ReceiverName</span>
                                        </div>
                                    }
                                </div>

                                <div class="pay-box pay-date">
                                    <div class="pay-line">
                                        <span class="pay-label">الوقت</span>
                                        <span class="pay-text">@timeTxt</span>
                                    </div>
                                    <div class="pay-line">
                                        <span class="pay-label">التاريخ</span>
                                        <span class="pay-text">@dateTxt</span>
                                    </div>
                                </div>
                            </div>

                        }
                    </div>
                }
            </div>

        </div>
    }
</div>

@code {
    [Parameter] public Guid StudentSemesterId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    bool IsReady;
    string StudentName = "";

    StudentFinanceViewLite? Header;
    List<PaymentLite> Payments = new();

    string Money(decimal? v) => $"{(v ?? 0m):0.00} دينار";

    protected override async Task OnInitializedAsync()
    {
        var authState = AuthenticationStateTask != null
            ? await AuthenticationStateTask
            : await AuthProvider.GetAuthenticationStateAsync();

        var user = authState.User;

        var idStr = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (!Guid.TryParse(idStr, out var studentId))
            return;
        StudentName = user.Identity?.Name ?? "";

        var headerTask = StudentSvc.GetStudentFinanceAsync(studentId, StudentSemesterId);
        var paymentsTask = StudentSvc.GetStudentPaymentsAsync(StudentSemesterId);

        await Task.WhenAll(headerTask, paymentsTask);

        Header = headerTask.Result;
        Payments = paymentsTask.Result ?? new();

        IsReady = true;
    }


    void GoBack() => Nav.NavigateTo("/Student/Home");
}
