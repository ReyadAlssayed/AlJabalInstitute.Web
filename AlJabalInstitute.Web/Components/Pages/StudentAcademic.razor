@page "/Student/Academic/{StudentSemesterId:guid}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using AlJabalInstitute.Web.Models
@using AlJabalInstitute.Web.Services
@attribute [Authorize]

@inject AuthenticationStateProvider AuthProvider
@inject StudentAuthService StudentSvc
@inject NavigationManager Nav

<div class="student-academic">

    <div class="acad-header">
        <div class="acad-header-top">
            <div class="acad-kicker">تفاصيل النتيجة</div>

            <h2 class="acad-title">
                <span class="acad-sem">@((Sem?.SemesterName ?? "السمستر"))</span>
            </h2>

            <div class="student-name">@Vm?.StudentName</div>

            <div class="acad-note">
                النظام قيد التطوير، لاحقًا سيتم إضافة كشف الدرجات للمواد كاملة.
            </div>
        </div>

        <div class="acad-header-bottom">
            <button class="back-btn" @onclick="GoBack">← رجوع</button>
        </div>
    </div>

    @if (!IsReady)
    {
        <div class="loading">جاري تحميل البيانات...</div>
    }
    else if (Vm == null || Sem == null)
    {
        <div class="empty">لا توجد بيانات أكاديمية لهذا السمستر.</div>
    }
    else
    {
        <div class="acad-card">

            @if (!Sem.IsVisible)
            {
                <div class="acad-hidden">النتيجة محجوبة</div>
            }
            else
            {
                var pct = Sem.Percentage;
                if (pct < 0) pct = 0;
                if (pct > 100) pct = 100;

                <div class="acad-progress">
                    <div class="prog-top">
                        <span class="prog-label">النسبة</span>
                        <span class="prog-val">@($"{Sem.Percentage:0.##}%")</span>
                    </div>

                    <div class="prog-track">
                        <div class="prog-fill" style="width:@pct%"></div>
                        <div class="prog-glow" style="left:calc(@pct% - 10px)"></div>
                    </div>
                </div>

                <div class="acad-stats">

                    <div class="acad-row one">
                        <div class="stat-box wide">
                            <div class="stat-label">عدد المواد التي درستها</div>
                            <div class="stat-value">@Sem.TotalSubjects</div>
                        </div>
                    </div>

                    <div class="acad-row two">
                        <div class="stat-box">
                            <div class="stat-label">ناجح</div>
                            <div class="stat-value">@Sem.PassedSubjects</div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">راسب</div>
                            <div class="stat-value">@Sem.FailedSubjects</div>
                        </div>
                    </div>

                    <div class="acad-row two">
                        <div class="stat-box">
                            <div class="stat-label">المجموع</div>
                            <div class="stat-value">@Sem.TotalScore</div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">النسبة</div>
                            <div class="stat-value">@($"{Sem.Percentage:0.##}%")</div>
                        </div>
                    </div>

                    <div class="acad-row one">
                        <div class="stat-box wide final">
                            <div class="stat-label">النتيجة النهائية</div>
                            <div class="stat-value bold">@Sem.FinalResult</div>
                        </div>
                    </div>

                </div>
            }

        </div>
    }
</div>

@code {
    [Parameter] public Guid StudentSemesterId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    bool IsReady;
    StudentAcademicPageVM? Vm;
    StudentAcademicSemesterCardVM? Sem;

    protected override async Task OnInitializedAsync()
    {
        var auth = AuthenticationStateTask != null
            ? await AuthenticationStateTask
            : await AuthProvider.GetAuthenticationStateAsync();

        var user = auth.User;
        var idStr = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (!Guid.TryParse(idStr, out var studentId))
            return;

        Vm = await StudentSvc.GetStudentAcademicPageAsync(studentId, StudentSemesterId);
        Sem = Vm?.Semesters?.FirstOrDefault(x => x.StudentSemesterId == StudentSemesterId);

        IsReady = true;
    }

    void GoBack() => Nav.NavigateTo("/Student/Home");
}
