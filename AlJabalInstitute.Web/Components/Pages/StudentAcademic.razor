@page "/Student/Academic/{StudentSemesterId:guid}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using AlJabalInstitute.Web.Models
@using AlJabalInstitute.Web.Services
@attribute [Authorize]

@inject AuthenticationStateProvider AuthProvider
@inject StudentAuthService StudentSvc
@inject NavigationManager Nav

<div class="student-academic">

    <div class="acad-header">
        <button class="back-btn" @onclick="GoBack">← رجوع</button>
        <h2>السجل الأكاديمي</h2>
        <div class="student-name">@Vm?.StudentName</div>
    </div>

    @if (!IsReady)
    {
        <div class="loading">جاري تحميل البيانات...</div>
    }
    else if (Vm == null || !Vm.Semesters.Any())
    {
        <div class="empty">لا توجد بيانات أكاديمية.</div>
    }
    else
    {
        <div class="acad-list">
            @foreach (var s in Vm.Semesters)
            {
                <div class="acad-card">

                    <div class="acad-card-header">
                        <span class="sem-name">@s.SemesterName</span>
                        <span class="sem-date">@s.StartDate.ToString("yyyy-MM")</span>
                    </div>

                    @if (!s.IsVisible)
                    {
                        <div class="acad-hidden">
                            النتيجة محجوبة
                        </div>
                    }
                    else
                    {
                        <div class="acad-grid">
                            <div>
                                <span class="lbl">عدد المواد</span>
                                <span class="val">@s.TotalSubjects</span>
                            </div>

                            <div>
                                <span class="lbl">ناجح</span>
                                <span class="val ok">@s.PassedSubjects</span>
                            </div>

                            <div>
                                <span class="lbl">راسب</span>
                                <span class="val warn">@s.FailedSubjects</span>
                            </div>

                            <div>
                                <span class="lbl">المجموع</span>
                                <span class="val">@s.TotalScore</span>
                            </div>

                            <div>
                                <span class="lbl">النسبة</span>
                                <span class="val">@($"{s.Percentage:0.##}%")</span>
                            </div>

                            <div class="final-result">
                                <span class="lbl">النتيجة النهائية</span>
                                <span class="val bold">@s.FinalResult</span>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public Guid StudentSemesterId { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    bool IsReady;
    StudentAcademicPageVM? Vm;

    protected override async Task OnInitializedAsync()
    {
        var auth = AuthenticationStateTask != null
            ? await AuthenticationStateTask
            : await AuthProvider.GetAuthenticationStateAsync();

        var user = auth.User;
        var idStr = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (!Guid.TryParse(idStr, out var studentId))
            return;

        Vm = await StudentSvc.GetStudentAcademicPageAsync(studentId, StudentSemesterId);
        IsReady = true;
    }

    void GoBack() => Nav.NavigateTo("/Student/Home");
}
