@page "/Student/Home"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using AlJabalInstitute.Web.Services
@using AlJabalInstitute.Web.Models
@attribute [Authorize]

@inject StudentAuthService SemestersSvc
@inject NavigationManager Nav

<div class="student-home">

    <div class="student-header">
        <h2 class="student-title">مرحبًا @StudentName</h2>
    </div>

    @if (!IsReady)
    {
        <div class="loading">جاري تحميل الفصول...</div>
    }
    else if (!Semesters.Any())
    {
        <div class="empty">لا توجد فصول مسجلة.</div>
    }
    else
    {
        <div class="semesters-list">
            @for (int i = 0; i < Semesters.Count; i++)
            {
                var sem = Semesters[i];

                // ✅ الأحدث فوق => رقم الفصل = العدد - i
                var semesterNumber = Semesters.Count - i;

                // ✅ الأحدث (أول بطاقة) هي "الأخير"
                var isLast = (i == 0);

                <div class="sem-card">
                    <div class="sem-top">
                        <div class="sem-name">@sem.SemesterName</div>

                        <div class="sem-no">
                            الفصل @semesterNumber
                            @if (isLast)
                            {
                                <span class="last-badge">الأخير لك</span>
                            }
                        </div>
                    </div>

                    <div class="sem-actions">
                        <button class="sem-btn sem-btn-fin"
                                @onclick="() => GoFinance(sem.StudentSemesterId)">
                            تفاصيل مالية
                        </button>

                        <button class="sem-btn sem-btn-ac"
                                @onclick="() => GoAcademic(sem.StudentSemesterId)">
                            تفاصيل أكاديمية
                        </button>
                    </div>
                </div>
            }
        </div>
    }

</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    string StudentName = "طالب";
    bool IsReady;
    List<StudentSemesterCard> Semesters = new();

    protected override async Task OnInitializedAsync()
    {
        IsReady = false;

        var authState = await AuthenticationStateTask;
        var user = authState.User;

        StudentName = user.Identity?.Name ?? "طالب";

        var idStr = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (!Guid.TryParse(idStr, out var studentId))
        {
            IsReady = true;
            return;
        }

        Semesters = await SemestersSvc.GetStudentSemestersAsync(studentId);

        IsReady = true;
    }

    void GoFinance(Guid studentSemesterId)
        => Nav.NavigateTo($"/Student/Finance/{studentSemesterId}");

    void GoAcademic(Guid studentSemesterId)
        => Nav.NavigateTo($"/Student/Academic/{studentSemesterId}");
}
