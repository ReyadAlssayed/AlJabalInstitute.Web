@page "/Student/Home"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using AlJabalInstitute.Web.Services
@using AlJabalInstitute.Web.Models
@attribute [Authorize]

@inject StudentAuthService SemestersSvc
@inject NavigationManager Nav

<div class="student-home">

    <div class="student-header">
        <h2 class="student-title">مرحبًا @StudentName</h2>
    </div>

    @if (!IsReady)
    {
        <div class="loading">جاري تحميل الفصول...</div>
    }
    else if (!Semesters.Any())
    {
        <div class="empty">لا توجد فصول مسجلة.</div>
    }
    else
    {
        <div class="semesters-grid">
            @for (int i = 0; i < Semesters.Count; i++)
            {
                var sem = Semesters[i];

                var semesterNumber = Semesters.Count - i;
                var isLast = (i == 0);

                // ✅ منطق الأكاديمية مثل الإدارة
                var isVisible = IsAcademicResultVisible(
                sem.IsResultsPublished,
                sem.IsFinanciallyExempt,
                sem.RemainingAmount,
                sem.ResultUnlockedUntil
                );

                <div class="sem-card">

                    <!-- TOP STRIP -->
                    <div class="sem-strip">
                        <div class="sem-strip-title">
                            @sem.SemesterName

                            @if (!sem.IsResultsPublished)
                            {
                                <span class="sem-pub-badge">النتائج غير منشورة</span>
                            }
                        </div>

                        <div class="sem-badges">
                            <span class="sem-num">@semesterNumber</span>

                            @if (isLast)
                            {
                                <span class="sem-last">الأخير لك</span>
                            }
                        </div>
                    </div>

                    <!-- BODY -->
                    <div class="sem-body">

                        <div class="sem-status">
                            <div class="status-row">
                                <span class="status-label">النتيجة:</span>

                                @if (!sem.IsResultsPublished)
                                {
                                    <span class="status-pill info">غير منشورة</span>
                                }
                                else
                                {
                                    <span class="status-pill @(isVisible ? "ok" : "warn")">
                                        @(isVisible ? "مرئية" : "محجوبة")
                                    </span>
                                }
                            </div>

                            <div class="status-row">
                                <span class="status-label">المالية:</span>

                                @if (sem.IsFinanciallyExempt)
                                {
                                    <span class="status-pill info">معفي</span>
                                }
                                else if (sem.RemainingAmount <= 0)
                                {
                                    <span class="status-pill ok">خالص</span>
                                }
                                else
                                {
                                    <span class="status-pill warn">غير خالص</span>
                                }
                            </div>
                        </div>

                        <div class="sem-actions">
                            <button class="sem-btn sem-btn-fin"
                                    @onclick="() => GoFinance(sem.StudentSemesterId)">
                                تفاصيل مالية
                            </button>

                            <button class="sem-btn sem-btn-ac"
                                    @onclick="() => GoAcademic(sem.StudentSemesterId)">
                                تفاصيل أكاديمية
                            </button>
                        </div>

                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    string StudentName = "طالب";
    bool IsReady;
    List<StudentSemesterCard> Semesters = new();

    protected override async Task OnInitializedAsync()
    {
        IsReady = false;

        var authState = await AuthenticationStateTask;
        var user = authState.User;

        StudentName = user.Identity?.Name ?? "طالب";

        var idStr = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (!Guid.TryParse(idStr, out var studentId))
        {
            IsReady = true;
            return;
        }

        Semesters = await SemestersSvc.GetStudentSemestersAsync(studentId);

        IsReady = true;
    }

    // ✅ نفس منطق الإدارة (AcademicServices)
    bool IsAcademicResultVisible(
        bool isResultsPublished,
        bool isFinanciallyExempt,
        decimal remainingAmount,
        DateTime? resultUnlockedUntil)
    {
        if (!isResultsPublished)
            return false;

        if (isFinanciallyExempt || remainingAmount == 0m)
            return true;

        if (resultUnlockedUntil != null && resultUnlockedUntil > DateTime.UtcNow)
            return true;

        return false;
    }

    void GoFinance(Guid studentSemesterId)
        => Nav.NavigateTo($"/Student/Finance/{studentSemesterId}");

    void GoAcademic(Guid studentSemesterId)
        => Nav.NavigateTo($"/Student/Academic/{studentSemesterId}");
}
