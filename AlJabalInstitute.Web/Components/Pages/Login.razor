@page "/"
@layout AuthLayout
@rendermode InteractiveServer

@using System.Net.Http.Json
@using AlJabalInstitute.Web.Services

@inject NavigationManager Nav
@inject ToastService ToastSvc
@inject IJSRuntime JS

<div class="student-auth-shell">

    <div class="student-auth-page">
        <div class="student-auth-card">

            <div class="auth-header">
                <div class="auth-header-content">
                    <h1>معهد الجبل العالي</h1>
                </div>
            </div>

            <div class="student-auth-body">

                <!-- الرقم الوطني -->
                <div class="field national">
                    <span class="field-icon material-symbols-outlined">badge</span>

                    <input placeholder="أدخل الرقم الوطني"
                           inputmode="numeric"
                           maxlength="12"
                           @bind="NationalId"
                           disabled="@IsSubmitting" />
                </div>

                <!-- كلمة السر -->
                <div class="field">
                    <span class="field-icon material-symbols-outlined">lock</span>

                    <input type="@PasswordInputType"
                           placeholder="أدخل كلمة السر"
                           maxlength="10"
                           @bind="Password"
                           disabled="@IsSubmitting" />

                    <button type="button"
                            class="field-action"
                            @onclick="TogglePassword"
                            disabled="@IsSubmitting">
                        @PasswordToggleText
                    </button>
                </div>

                <button class="primary-btn"
                        disabled="@IsSubmitting"
                        @onclick="DoLogin">
                    @(IsSubmitting ? "جاري تسجيل الدخول..." : "تسجيل الدخول")
                </button>

                <!-- ✅ زر الإرشادات -->
                <button type="button"
                        class="help-btn"
                        disabled="@IsSubmitting"
                        @onclick="OpenHelp">
                    إرشادات عامة للنظام
                </button>

            </div>
        </div>
    </div>

</div>

<!-- ✅ مودال الإرشادات -->
@if (IsHelpOpen)
{
    <div class="modal-backdrop" @onclick="CloseHelp">
        <div class="modal-card" @onclick:stopPropagation="true" role="dialog" aria-modal="true">
            <div class="modal-top">
                <div class="modal-title">إرشادات عامة</div>
            </div>

            <div class="modal-body">
                <ol class="help-list">
                    <li>
                        لتسجيل الدخول للنظام لابد من كتابة <b>الرقم الوطني</b> الخاص بالطالب (مكون من <b>12 رقم</b>).
                        <br />
                        <b>وكلمة السر</b> الخاصة بالطالب تُمنح له من <b>الإدارة</b> وتبقى ثابتة طوال فترته الدراسية ويسجّل بها دائمًا.
                    </li>

                    <li>
                        داخل الواجهات تُعرض السمسترات التي درس بها الطالب مرقمة،
                        مع عرض <b>آخر سمستر</b> بشكل واضح <b>أعلى الواجهة</b>.
                    </li>

                    <li>
                        في بطاقة كل سمستر يوجد زرين:
                        <b>تفاصيل المالية</b> و<b>تفاصيل النتيجة</b>
                        
                        عند النقر عليها تُفتح تفاصيلها الخاصة بالطالب.
                    </li>
                </ol>
            </div>


            <div class="modal-actions">
                <button type="button" class="modal-close" @onclick="CloseHelp">إغلاق</button>
            </div>
        </div>
    </div>
}

@code {
    string NationalId = "";
    string Password = "";

    bool ShowPassword = false;
    bool IsSubmitting = false;

    bool IsHelpOpen = false;

    string PasswordInputType => ShowPassword ? "text" : "password";
    string PasswordToggleText => ShowPassword ? "إخفاء" : "إظهار";

    void TogglePassword()
    {
        if (IsSubmitting) return;
        ShowPassword = !ShowPassword;
    }

    void OpenHelp()
    {
        if (IsSubmitting) return;
        IsHelpOpen = true;
    }

    void CloseHelp() => IsHelpOpen = false;

    async Task DoLogin()
    {
        if (IsSubmitting)
            return;

        IsSubmitting = true;

        if (NationalId.Length != 12 || !NationalId.All(char.IsDigit))
        {
            ToastSvc.Error("الرقم الوطني يجب أن يكون 12 رقمًا");
            IsSubmitting = false;
            return;
        }

        if (Password.Length == 0 || Password.Length > 10)
        {
            ToastSvc.Error("كلمة السر يجب ألا تتجاوز 10 أحرف");
            IsSubmitting = false;
            return;
        }

        try
        {
            var r = await JS.InvokeAsync<LoginJsResult>(
                "studentLogin",
                NationalId,
                Password
            );

            if (!r.ok)
            {
                ToastSvc.Error(
                    string.IsNullOrWhiteSpace(r.text)
                        ? "بيانات الدخول غير صحيحة"
                        : r.text
                );

                IsSubmitting = false;
                return;
            }

            ToastSvc.Success("تم تسجيل الدخول بنجاح");
            Nav.NavigateTo("/Student/Home", true);
        }
        catch
        {
            ToastSvc.Error("حدث خطأ غير متوقع");
            IsSubmitting = false;
        }
    }

    public class LoginJsResult
    {
        public bool ok { get; set; }
        public string? text { get; set; }
    }
}
